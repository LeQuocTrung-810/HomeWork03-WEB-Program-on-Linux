<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Web IoT LungQuocTre</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; }
  #dashboard, #grafana-frame { display: none; }
  input { margin: 5px; padding: 5px; }
  button { padding: 5px 10px; margin: 5px; }
  #sensor-data p { margin: 5px 0; }
</style>
</head>
<body>

<!-- Login Form -->
<div id="login-form">
  <h2>Login</h2>
  <input id="username" placeholder="Username"><br>
  <input id="password" type="password" placeholder="Password"><br>
  <button onclick="login()">Login</button>
</div>

<!-- Dashboard -->
<div id="dashboard">
  <h2>Dashboard IoT</h2>
  <p>Xin chào, <span id="user-name"></span> | <a href="#" onclick="logout()">Logout</a></p>

  <div id="sensor-data">
    <p>Nhiệt độ: <span id="temp">--</span> °C</p>
    <p>Độ ẩm: <span id="hum">--</span> %</p>
    <button onclick="showGrafana()">Xem biểu đồ lịch sử</button>
  </div>

  <!-- Grafana iframe -->
  <iframe id="grafana-frame" style="width:100%; height:400px;"></iframe>
</div>

<script>
// ======== Utility: SHA-256 hash ========
async function sha256(message) {
  const msgBuffer = new TextEncoder().encode(message);
  const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  return hashArray.map(b => b.toString(16).padStart(2,'0')).join('');
}

// ======== Login Function ========
async function login(){
  const username = document.getElementById("username").value;
  const password = document.getElementById("password").value;
  if(!username || !password){ alert("Nhập đầy đủ username và password"); return; }

  const password_hash = await sha256(password);
  try {
    const res = await fetch('/api/login', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({username,password_hash})
    });
    const data = await res.json();
    if(data.success){
      // Lưu session vào localStorage
      localStorage.setItem('user', data.username);
      showDashboard(data.username);
      getLatestData(); // Bắt đầu cập nhật dữ liệu
    } else {
      alert(data.message);
    }
  } catch(err){
    alert("Lỗi kết nối đến server: "+err);
  }
}

// ======== Logout ========
function logout(){
  localStorage.removeItem('user');
  document.getElementById('dashboard').style.display = 'none';
  document.getElementById('login-form').style.display = 'block';
}

// ======== Hiển thị Dashboard ========
function showDashboard(username){
  document.getElementById('login-form').style.display = 'none';
  document.getElementById('dashboard').style.display = 'block';
  document.getElementById('user-name').innerText = username;
}

// ======== Kiểm tra session ========
window.onload = function(){
  const user = localStorage.getItem('user');
  if(user){
    showDashboard(user);
    getLatestData();
  }
};

// ======== Lấy dữ liệu cảm biến mới nhất ========
async function getLatestData(){
  try{
    const res = await fetch('/api/latest');
    const data = await res.json();
    if(data.temperature !== undefined){
      document.getElementById('temp').innerText = data.temperature;
      document.getElementById('hum').innerText = data.humidity;
    }
  }catch(err){
    console.log("Lỗi lấy dữ liệu:", err);
  }
  // Cập nhật 5s 1 lần
  setTimeout(getLatestData, 5000);
}

// ======== Hiển thị Grafana iframe ========
function showGrafana(){
  const iframe = document.getElementById('grafana-frame');
  iframe.src = "http://fullname.com/grafana"; // URL Grafana qua Nginx
  iframe.style.display = 'block';
  iframe.scrollIntoView({behavior:'smooth'});
}
</script>
</body>
</html>
